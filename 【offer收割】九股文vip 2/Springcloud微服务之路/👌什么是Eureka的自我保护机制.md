Eureka 的自我保护机制（Self-Preservation Mode）是为了防止在网络分区或短暂的网络故障情况下错误地剔除服务实例而设计的一种保护措施。它的主要目的是提高系统的容错能力和稳定性，确保服务在网络波动或故障时仍能正常运行。
### 自我保护机制的工作原理
Eureka Server 会定期接收来自 Eureka Client 的心跳请求，以确认服务实例的健康状态。如果在一定时间内没有收到某个服务实例的心跳请求，Eureka Server 通常会认为该实例已经不可用，并将其从注册表中剔除。<br />然而，在一些特殊情况下，例如网络分区、网络抖动或瞬时的网络故障，Eureka Server 可能会暂时无法接收到大量服务实例的心跳请求。在这种情况下，如果按照正常逻辑剔除这些实例，可能会导致系统中大部分服务实例被错误地剔除，影响整个系统的稳定性。<br />为了解决这一问题，Eureka 引入了自我保护机制。当 Eureka Server 检测到在一定时间内（默认 15 分钟）丢失的心跳请求超过一定比例（默认 85%）时，会自动进入自我保护模式。
### 自我保护机制的行为
在自我保护模式下，Eureka Server 会停止剔除没有发送心跳请求的服务实例，而是保持现有的注册表数据不变。具体行为包括：

1. **停止剔除服务实例**：即使某些服务实例在一段时间内没有发送心跳请求，Eureka Server 也不会将其从注册表中剔除。
2. **继续接受新的注册和更新**：Eureka Server 仍然会接受新的服务实例注册和已有实例的信息更新。
3. **发出警告日志**：Eureka Server 会记录警告日志，提示管理员系统可能处于自我保护模式，需要检查网络状况和系统健康状态。
### 自我保护机制的配置
自我保护机制可以通过配置文件进行启用或禁用。默认情况下，自我保护机制是启用的。
```
eureka:
  server:
    enable-self-preservation: true # 启用自我保护机制
    renewal-percent-threshold: 0.85 # 心跳丢失比例阈值，默认 85%
```

- `eureka.server.enable-self-preservation`: 是否启用自我保护机制，默认值为 `true`。
- `eureka.server.renewal-percent-threshold`: 心跳丢失比例阈值，当丢失的心跳请求超过该比例时触发自我保护模式，默认值为 `0.85`（即 85%）。
### 自我保护机制的优缺点
#### 优点

- **提高系统容错能力**：在网络分区或短暂的网络故障情况下，防止错误地剔除大量服务实例。
- **保证服务可用性**：即使在网络波动时，仍能保持服务注册表的一致性和稳定性。
#### 缺点

- **可能导致僵尸实例**：在自我保护模式下，某些确实已经不可用的服务实例可能不会被及时剔除，导致注册表中存在僵尸实例。
- **需要额外监控**：管理员需要对自我保护模式进行监控和管理，确保在网络恢复后及时退出自我保护模式。
### 总结
Eureka 的自我保护机制是一种重要的容错措施，用于防止在网络分区或短暂的网络故障情况下错误地剔除服务实例。通过自我保护机制，Eureka 可以提高系统的稳定性和可用性，确保服务在网络波动时仍能正常运行。然而，自我保护机制也可能导致注册表中存在僵尸实例，因此需要管理员进行额外的监控和管理。
