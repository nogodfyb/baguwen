Eureka 的基本架构主要包括 Eureka Server 和 Eureka Client 两个核心组件。
### 1. **Eureka Server**
Eureka Server 是服务注册中心，负责维护所有注册的服务实例的信息。它的主要功能包括：

- **服务注册**：接收来自 Eureka Client 的服务注册请求，并将服务实例的信息保存到注册表中。
- **服务发现**：响应 Eureka Client 的服务查询请求，返回已注册的服务实例列表。
- **心跳检测**：接收来自 Eureka Client 的心跳请求，更新服务实例的状态。
- **剔除机制**：当某个服务实例在一定时间内未发送心跳请求时，将其从注册表中剔除。
- **自我保护模式**：在网络分区或短暂的网络故障情况下，防止服务实例被错误地剔除。
### 2. **Eureka Client**
Eureka Client 运行在每个微服务实例中，负责与 Eureka Server 进行通信。它的主要功能包括：

- **服务注册**：在启动时向 Eureka Server 注册自身的服务信息。
- **心跳发送**：定期向 Eureka Server 发送心跳请求，表明服务实例仍然在线。
- **服务发现**：从 Eureka Server 获取已注册的服务实例列表，用于服务间的调用。
- **缓存机制**：本地缓存服务实例列表，以减少对 Eureka Server 的频繁请求，提高服务发现的效率。
### 3. **Eureka 的工作流程**
Eureka 的工作流程可以分为以下几个步骤：

1. **服务注册**：
   - 当一个微服务实例启动时，它会向 Eureka Server 发送注册请求，包含服务的元数据（如服务名、IP 地址、端口等）。
   - Eureka Server 接收到注册请求后，将该服务实例的信息保存到注册表中。
2. **心跳检测**：
   - 注册后，微服务实例会定期（默认每 30 秒）向 Eureka Server 发送心跳请求。
   - Eureka Server 接收到心跳请求后，更新该服务实例的状态，表明它仍然在线。
3. **服务发现**：
   - 当一个微服务需要调用另一个服务时，它会向 Eureka Server 查询已注册的服务实例列表。
   - Eureka Server 返回目标服务的实例列表，调用方选择一个实例进行调用。
4. **服务剔除**：
   - 如果 Eureka Server 在一段时间内（默认 90 秒）没有收到某个服务实例的心跳请求，它会将该实例标记为不可用并从注册表中剔除。
5. **自我保护模式**：
   - 当 Eureka Server 在一定时间内检测到心跳丢失的比例过高时，它会进入自我保护模式，停止剔除服务实例，以确保在网络恢复后服务能快速恢复。
### 4. **高可用性架构**
为了提高系统的可靠性和可用性，Eureka Server 通常部署为集群模式。Eureka Server 实例之间会相互同步注册表数据，确保即使某个实例宕机，其他实例仍能提供服务注册和发现功能。
### 5. **Eureka 的数据同步**
在 Eureka 集群中，Eureka Server 实例之间会进行数据同步，以确保注册表数据的一致性。数据同步的主要机制包括：

- **全量同步**：Eureka Server 实例启动时，会从其他实例获取完整的注册表数据。
- **增量同步**：Eureka Server 实例之间会定期交换增量数据，更新注册表中的变化。
### 6. **Eureka 的自我保护机制**
Eureka 的自我保护机制用于防止网络分区或短暂的网络故障导致服务实例被错误地剔除。具体机制如下：

- **自我保护模式触发条件**：当 Eureka Server 在一定时间内（默认 15 分钟）检测到心跳丢失的比例超过 85% 时，会触发自我保护模式。
- **自我保护模式行为**：在自我保护模式下，Eureka Server 停止剔除服务实例，保持现有的注册表数据不变。
### 总结
Eureka 的基本架构由 Eureka Server 和 Eureka Client 组成，通过服务注册、心跳检测、服务发现和服务剔除等机制，实现了微服务的动态管理和高可用性。Eureka Server 的高可用性架构和自我保护机制进一步提升了系统的可靠性和容错能力。
