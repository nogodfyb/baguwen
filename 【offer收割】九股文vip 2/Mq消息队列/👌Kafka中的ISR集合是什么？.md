它用于确保 Kafka 集群的高可用性和数据一致性。
### ISR（In-Sync Replicas）集合定义
ISR 集合是指一个 Kafka 分区中所有与领导者副本保持同步的副本集合。这些副本包含了与领导者副本相同的数据，并且能够在领导者副本发生故障时迅速接替成为新的领导者。
### 详细说明

1. **同步副本**：
   - **领导者副本（Leader Replica）**：每个分区都有一个领导者副本，负责处理所有的读写请求。
   - **跟随者副本（Follower Replicas）**：除了领导者副本，分区还有多个跟随者副本，它们从领导者副本复制数据。
2. **同步条件**：
   - 一个副本被认为是同步的，如果它在一定时间内（由参数replica.lag.time.max.ms控制）没有落后于领导者副本超过允许的滞后时间。
   - 另外，Kafka 也可以通过replica.lag.max.messages参数来控制副本滞后消息的最大数量。
3. **ISR 集合的动态性**：
   - ISR 集合是动态变化的。当一个跟随者副本与领导者副本保持同步，它就会被加入到 ISR 集合中。
   - 如果一个跟随者副本的滞后时间或滞后消息数超过了允许的阈值，它将被从 ISR 集合中移除。
### 作用

1. **高可用性**：
   - 如果领导者副本崩溃，ISR 集合中的一个副本会被选为新的领导者，从而保证分区的可用性。
2. **数据一致性**：
   - 只有在消息被写入到 ISR 集合中的所有副本后，Kafka 才会确认消息的写入成功。这确保了数据的一致性。
### 配置参数

- replica.lag.time.max.ms：一个跟随者副本落后于领导者副本的最大时间，超过这个时间将被认为不同步。
- replica.lag.max.messages：一个跟随者副本落后于领导者副本的最大消息数，超过这个数量将被认为不同步。
### 示例
假设一个 Kafka 分区有三个副本，分别是副本 0、1 和 2。副本 0 是领导者副本，副本 1 和 2 是跟随者副本。

- 如果副本 1 和 2 都与副本 0 同步，那么 ISR 集合为 {0, 1, 2}。
- 如果副本 2 落后于副本 0 超过了允许的滞后时间或滞后消息数，副本 2 将从 ISR 集合中移除，此时 ISR 集合为 {0, 1}。
### 总结

- **ISR（In-Sync Replicas）集合**：与领导者副本保持同步的一组副本，确保数据的高可用性和一致性。
- **动态变化**：ISR 集合会根据副本的同步状态动态变化，确保只有与领导者副本同步的副本在集合中。
- **高可用性和一致性**：通过 ISR 集合，Kafka 能够在领导者副本故障时快速选出新的领导者，并确保消息写入的可靠性。
