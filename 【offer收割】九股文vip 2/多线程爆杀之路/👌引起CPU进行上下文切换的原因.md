- CPU 上下文切换是指 CPU 从一个进程或线程切换到另一个进程或线程的过程。
- 上下文切换涉及保存当前进程或线程的状态，并加载即将运行的进程或线程的状态。
- 上下文切换是多任务操作系统中实现并发的重要机制，但频繁的上下文切换会带来性能开销。
### 1. 时间片耗尽
在抢占式多任务操作系统中，每个进程或线程都被分配一个固定长度的时间片。当时间片耗尽时，操作系统会进行上下文切换，将 CPU 分配给下一个进程或线程。
### 2. 阻塞操作
当一个进程或线程执行阻塞操作（如 I/O 操作、等待锁、等待资源等）时，它会进入阻塞状态，操作系统会进行上下文切换，将 CPU 分配给其他可以运行的进程或线程。
### 3. 进程或线程的优先级变化
操作系统调度程序会根据进程或线程的优先级进行调度。如果一个高优先级的进程或线程进入就绪状态，操作系统可能会进行上下文切换，将 CPU 分配给这个高优先级的进程或线程。
### 4. 中断
硬件中断（如定时器中断、I/O 中断等）也会触发上下文切换。当中断发生时，操作系统会暂停当前进程或线程的执行，处理中断请求，然后可能会切换到另一个进程或线程。
### 5. 系统调用
当进程或线程执行系统调用时，可能会引发上下文切换。例如，当进程请求操作系统服务（如文件操作、网络操作等）时，操作系统可能会切换到内核态进行处理，然后再切换回用户态。
### 6. 多处理器环境中的负载均衡
在多处理器或多核系统中，操作系统可能会进行上下文切换以实现负载均衡。操作系统会将进程或线程分配到不同的 CPU 核心，以优化资源利用率和性能。
### 7. 线程调度策略
不同的线程调度策略（如时间片轮转、优先级调度等）会导致上下文切换。例如，在时间片轮转调度策略中，每个线程按顺序获得 CPU 时间片，当时间片用完时，操作系统会进行上下文切换。
### 8. 用户态和内核态切换
当进程或线程从用户态切换到内核态（例如执行系统调用）或从内核态切换回用户态时，也会发生上下文切换。这种切换涉及保存和恢复 CPU 寄存器等状态。
### 上下文切换的开销
上下文切换虽然是多任务操作系统实现并发的必要机制，但它也带来了性能开销，主要包括：

- **CPU 寄存器保存和恢复**：需要保存当前进程或线程的 CPU 寄存器状态，并加载下一个进程或线程的 CPU 寄存器状态。
- **内存管理**：需要切换内存管理单元（MMU）的上下文，例如页表的切换。
- **缓存失效**：上下文切换可能导致 CPU 缓存失效，从而影响性能。
### 优化上下文切换

- **减少线程数量**：避免创建过多的线程，合理使用线程池。
- **减少锁竞争**：使用无锁数据结构或更细粒度的锁，减少线程间的锁竞争。
- **优化调度策略**：根据应用场景选择合适的调度策略，避免不必要的优先级切换。
- **使用异步 I/O**：尽量使用异步 I/O 操作，减少阻塞操作引起的上下文切换。
