Redis主从复制的核心原理可以概括为以下几个关键步骤和要点：<br />1. 主从复制架构

- **主从复制**：Redis支持主从复制模式，其中一台服务器作为主服务器（Master），可以接收写请求；而一个或多个服务器作为从服务器（Slave），只能接收读请求。
- **配置**：通过SLAVEOF命令或配置文件中设置slaveof选项，让从服务器复制主服务器的数据。

2. 复制过程<br />同步阶段

1. **发送SYNC命令**：从服务器向主服务器发送SYNC命令，请求同步数据。
2. **创建RDB文件**：主服务器接收到SYNC命令后，在后台执行BGSAVE命令，生成一个RDB快照文件，这个文件包含了主服务器当前的数据状态。
3. **发送RDB文件**：主服务器将生成的RDB文件发送给从服务器，从服务器接收并加载该文件，更新自己的数据状态。

命令传播阶段

1. **持续复制**：一旦从服务器加载完RDB文件，主从复制就进入了命令传播阶段。此时，主服务器会将所有接收到的写命令发送给从服务器，确保主从数据的一致性。
2. **异步复制**：Redis的主从复制是异步的，这意味着主服务器在发送写命令给从服务器时，不会等待从服务器的响应，从而保证了主服务器的高可用性。

3. 复制偏移量和复制积压缓冲区

- **复制偏移量**：主从服务器都会维护一个复制偏移量（offset），用于记录复制过程中传输的数据量。通过比较主从服务器的复制偏移量，可以判断数据是否一致。
- **复制积压缓冲区**：主服务器维护了一个固定长度的、先进先出（FIFO）的队列作为复制积压缓冲区，用于保存最近一段时间内的写命令。当从服务器重新连接主服务器时，如果复制偏移量在复制积压缓冲区范围内，主服务器可以直接将从断线位置开始的写命令发送给从服务器，实现部分重同步。

4. 断线重连<br />当从节点与主节点的连接断开后，会自动尝试重新连接：

- 如果从节点重新连接主节点时，发现自己的复制偏移量在主节点的复制积压缓冲区范围内，则会进行增量同步。
- 如果复制积压缓冲区中的数据不足以完成同步，则需要重新进行全量同步。

5. 主从切换<br />Redis 支持手动和自动的主从切换：

- **手动切换**：通过客户端命令手动将某个从节点提升为主节点。
- **自动切换**：使用 Redis Sentinel 实现自动故障转移，当主节点发生故障时，Sentinel 会自动将某个从节点提升为主节点，并通知其他从节点重新复制新的主节点。
```
复制过程示例
假设有一个主节点 Master 和两个从节点 Slave1 和 Slave2，其复制过程如下：

初始化同步：

Slave1 和 Slave2 向 Master 发起同步请求。
Master 生成 RDB 快照并发送给 Slave1 和 Slave2。
Slave1 和 Slave2 加载 RDB 文件，完成初始化同步。
增量同步：

Master 接收到写命令（如 SET key value），执行并将命令发送给 Slave1 和 Slave2。
Slave1 和 Slave2 执行收到的命令，保持数据一致。
部分重同步：

Slave1 与 Master 的连接中断并重新连接。
Slave1 向 Master 发送复制偏移量请求部分重同步。
Master 根据偏移量从复制积压缓冲区中提取命令，发送给 Slave1。
Slave1 执行命令，完成部分重同步。
```
